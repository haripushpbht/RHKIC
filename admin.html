<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RHKIC Admin Dashboard</title>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom right, #D32F2F, #FBC02D, #6D4C41);
  color: white;
  padding: 20px;
}
h1 { text-align: center; }
button { 
  padding: 10px 20px; 
  border: none; 
  border-radius: 5px; 
  cursor: pointer; 
  background: #FBC02D; 
  color: black; 
  font-weight: bold;
  margin-bottom: 10px;
}
button:hover { background: #FFD600; }
.user-list, .notice-board, .homework-board {
  margin-top: 20px;
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 10px;
  backdrop-filter: blur(5px);
}
.user-list table, .homework-board table {
  width: 100%;
  border-collapse: collapse;
  color: white;
}
.user-list th, .user-list td, .homework-board th, .homework-board td {
  padding: 8px;
  border: 1px solid #fff;
  text-align: left;
}
select, input[type=text] { padding: 6px; border-radius:5px; border:none; }
</style>
</head>
<body>

<div style="display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:12px;">
  <a href="index.html"><img src="logooooo.png" alt="RHKIC Logo" style="width:64px;height:64px;border-radius:8px;object-fit:cover;"></a>
  <div style="font-weight:700;font-size:18px;color:#fff;">RHKIC BANDIYA</div>
</div>

<h1>üë®‚Äçüíº Principal / Admin Dashboard</h1>
<div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:10px;">
  <a href="index.html" style="color:yellow;font-weight:bold;text-decoration:none;">Home</a>
  <button onclick="logout()">Logout</button>
</div>

<!-- Registered Users -->
<div class="user-list">
<h2>Registered Users</h2>
<select id="userSelect" onchange="loadUserHomework(this.value)">
  <option value="">Select user to view homework</option>
</select>
<table id="usersTable">
  <tr>
    <th>Email</th>
    <th>Role</th>
  </tr>
</table>
</div>

<!-- Homework Management -->
<div class="homework-board">
<h2>Homework Management</h2>
<input type="text" id="homeworkText" placeholder="Enter homework" style="width:60%;">
<button onclick="addHomework()">Add Homework</button>
<table id="homeworkTable">
  <thead>
    <tr>
      <th>Homework</th>
      <th>User</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="homeworkTbody"></tbody>
</table>
</div>

<!-- Notice Management -->
<div class="notice-board">
<h2>Add Notice / Announcement</h2>
<input type="text" id="noticeText" placeholder="Enter notice" style="width:80%;">
<button onclick="addNotice()">Add Notice</button>
<ul id="noticeList"></ul>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIjL0gWAAe-kd1jcbqZeWqSbHj4Yi9jDI",
  authDomain: "rhkic-bandiya.firebaseapp.com",
  databaseURL: "https://rhkic-bandiya-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhkic-bandiya",
  storageBucket: "rhkic-bandiya.firebasestorage.app",
  messagingSenderId: "1050448660999",
  appId: "1:1050448660999:web:111aade54c5392df6a78a2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Logout
window.logout = () => { signOut(auth).then(()=> window.location.href="index.html"); };

// Auth check & load users
onAuthStateChanged(auth, async (user) => {
  if(!user) window.location.href = "auth.html";
  const uid = user.uid;
  const snapshot = await get(ref(db, "users/" + uid));
  if(snapshot.exists()){
    const role = snapshot.val().role;
    if(role !== "admin" && role !== "principal"){
      alert("Access denied! Only admin/principal can view this page.");
      window.location.href = "index.html";
    }
  } else { window.location.href = "auth.html"; }

  await loadUsers();
  await loadNotices();
});

// Load users
async function loadUsers(){
  const snapshot = await get(ref(db, "users/"));
  const table = document.getElementById("usersTable");
  const select = document.getElementById("userSelect");
  table.innerHTML = "<tr><th>Email</th><th>Role</th></tr>";
  select.innerHTML = '<option value="">Select user to view homework</option>';
  if(snapshot.exists()){
    const users = snapshot.val();
    Object.keys(users).forEach(uid => {
      const row = table.insertRow();
      row.insertCell(0).innerText = users[uid].email || uid;
      row.insertCell(1).innerText = users[uid].role || '';
      // Add to dropdown
      const option = document.createElement('option');
      option.value = uid;
      option.innerText = users[uid].email || uid;
      select.appendChild(option);
    });
  }
}

// Add homework
async function addHomework(){
  const hwText = document.getElementById("homeworkText").value.trim();
  const userSelect = document.getElementById("userSelect");
  const uid = userSelect.value;
  if(!hwText || !uid) return alert("Select user and enter homework");
  try{
    const hwRef = push(ref(db, "homework/"));
    await set(hwRef, { text: hwText, user: uid, createdAt: new Date().toISOString() });
    document.getElementById("homeworkText").value = "";
    loadUserHomework(uid);
  } catch(err){ alert('Error adding homework: '+err.message); }
}

// Load homework for selected user
async function loadUserHomework(uid){
  const tbody = document.getElementById("homeworkTbody");
  tbody.innerHTML = '';
  if(!uid) return;
  const snapshot = await get(ref(db, "homework/"));
  if(snapshot.exists()){
    const homework = snapshot.val();
    Object.entries(homework).forEach(([key, hw]) => {
      if(hw.user === uid){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${hw.text}</td><td>${uid}</td><td><button onclick="deleteHomework('${key}','${uid}')">Delete</button></td>`;
        tbody.appendChild(tr);
      }
    });
  }
}

// Delete homework
async function deleteHomework(hwId, uid){
  if(!confirm("Delete this homework?")) return;
  try{
    await remove(ref(db, "homework/"+hwId));
    loadUserHomework(uid);
  } catch(err){ alert('Error deleting homework: '+err.message); }
}

// Add notice
async function addNotice(){
  const noticeText = document.getElementById("noticeText").value.trim();
  if(!noticeText) return alert("Enter notice");
  try{
    const noticeRef = push(ref(db,"notices/"));
    await set(noticeRef,{ text: noticeText, createdAt: new Date().toISOString() });
    document.getElementById("noticeText").value = "";
    loadNotices();
  } catch(err){ alert('Error adding notice: '+err.message); }
}

// Load notices
async function loadNotices(){
  const list = document.getElementById("noticeList");
  list.innerHTML = '';
  const snapshot = await get(ref(db,"notices/"));
  if(snapshot.exists()){
    const notices = snapshot.val();
    Object.values(notices).forEach(n => {
      const li = document.createElement('li');
      li.innerText = n.text || '';
      list.appendChild(li);
    });
  }
}
</script>
</body>
</html>

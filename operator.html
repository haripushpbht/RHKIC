<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Operator Dashboard - Students</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: linear-gradient(to bottom right, #2e7d32, #66bb6a, #a5d6a7); color: #fff; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; }
  .controls { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:20px; }
  select, button { padding:10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
  select { background:rgba(255,255,255,0.2); color:#fff; }
  button { background:#FBC02D; color:#000; }
  button:hover { background:#FFD600; }
  table { width:100%; border-collapse:collapse; margin-top:10px; background:rgba(255,255,255,0.15); border-radius:10px; overflow:hidden; }
  th, td { padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.3); }
  th { background:rgba(0,0,0,0.3); color:#FFD600; }
  td input { width:100%; background:rgba(255,255,255,0.1); border:none; border-radius:4px; color:#fff; padding:6px; }
  .actions button { padding:5px 10px; margin-right:5px; border:none; border-radius:4px; font-weight:600; cursor:pointer; }
  .edit { background:#29B6F6; color:#000; }
  .delete { background:#E53935; color:#fff; }
  .muted { opacity:0.85; font-size:14px; }
</style>
</head>
<body>
  <div style="text-align:center;margin-bottom:15px;">
    <img src="logooooo.png" alt="logo" width="60" style="border-radius:10px;">
    <h1>Operator Panel - Student Data</h1>
  </div>

  <div class="controls">
    <label style="font-weight:700; margin-right:6px;">Class:</label>
    <select id="classSelect">
      <option value="all">All</option>
      <option value="Class 1">Class 1</option>
      <option value="Class 2">Class 2</option>
      <option value="Class 3">Class 3</option>
      <option value="Class 4">Class 4</option>
      <option value="Class 5">Class 5</option>
      <option value="Class 6">Class 6</option>
      <option value="Class 7">Class 7</option>
      <option value="Class 8">Class 8</option>
      <option value="Class 9">Class 9</option>
      <option value="Class 10">Class 10</option>
      <option value="Class 11">Class 11</option>
      <option value="Class 12">Class 12</option>
    </select>
    <button id="showBtn" onclick="loadStudents()" disabled>Show</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="muted" id="statusLine">Verifying user...</div>

  <table id="studentsTable" aria-live="polite">
    <thead>
      <tr>
        <th>Name</th>
        <th>Father</th>
        <th>Mother</th>
        <th>Class</th>
        <th>Mobile</th>
        <th>WhatsApp</th>
        <th>Address</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="studentsBody">
      <tr><td colspan="8">Loading...</td></tr>
    </tbody>
  </table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIjL0gWAAe-kd1jcbqZeWqSbHj4Yi9jDI",
  authDomain: "rhkic-bandiya.firebaseapp.com",
  databaseURL: "https://rhkic-bandiya-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhkic-bandiya",
  storageBucket: "rhkic-bandiya.firebasestorage.app",
  messagingSenderId: "1050448660999",
  appId: "1:1050448660999:web:111aade54c5392df6a78a2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const showBtn = document.getElementById('showBtn');
const statusLine = document.getElementById('statusLine');

// disable show until auth verified
showBtn.disabled = true;
statusLine.innerText = 'Checking authentication...';

let currentUser = null;

// verify auth and role
onAuthStateChanged(auth, async user => {
  if (!user) {
    statusLine.innerText = 'Not authenticated. Redirecting to login...';
    setTimeout(()=> window.location.href = 'auth.html', 800);
    return;
  }
  currentUser = user;
  try {
    const snap = await get(ref(db, 'users/' + user.uid));
    console.log('Operator auth check:', snap.exists()? snap.val() : null);
    if (!snap.exists()) {
      statusLine.innerText = 'User record not found in database.';
      alert('Access denied: no user record. Contact admin.');
      return;
    }
    const role = snap.val().role;
    if (role !== 'operator') {
      statusLine.innerText = 'Access denied: not an operator.';
      alert('Access denied: your account is not operator.');
      window.location.href = 'index.html';
      return;
    }
    // ready
    statusLine.innerText = 'Authenticated as operator — select class and click Show.';
    showBtn.disabled = false;
  } catch (e) {
    console.error('Auth check error', e);
    statusLine.innerText = 'Auth verification error — see console.';
    alert('Failed to verify operator access — check console.');
  }
});

// logout
window.logout = () => signOut(auth).then(()=> window.location.href='index.html').catch(e=>{console.error(e); alert('Logout failed');});

// helper: sanitize values
function valOrEmpty(v){ return (v===undefined || v===null) ? '' : String(v); }

// main loader
window.loadStudents = async function(){
  const cls = document.getElementById('classSelect').value;
  const tbody = document.getElementById('studentsBody');
  tbody.innerHTML = '<tr><td colspan="8">Loading students...</td></tr>';
  console.log('loadStudents called for class=', cls);

  try {
    const snap = await get(ref(db, 'users'));
    if (!snap.exists()) {
      tbody.innerHTML = '<tr><td colspan="8">No users found in DB.</td></tr>';
      return;
    }
    const usersObj = snap.val();
    // convert to array with uid
    const usersArr = Object.entries(usersObj).map(([uid,u]) => ({ uid, ...u }));
    // filter students only
    const students = usersArr.filter(u => u.role === 'student');
    const filtered = (cls === 'all') ? students : students.filter(s => (s.student && s.student.class) === cls);

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="8">No students found for ${cls}</td></tr>`;
      return;
    }

    // build rows
    tbody.innerHTML = '';
    filtered.forEach(s => {
      const st = s.student || {};
      const uid = s.uid;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input id="name-${uid}" value="${escapeHtml(valOrEmpty(st.fullName))}"></td>
        <td><input id="father-${uid}" value="${escapeHtml(valOrEmpty(st.fatherName))}"></td>
        <td><input id="mother-${uid}" value="${escapeHtml(valOrEmpty(st.motherName))}"></td>
        <td><input id="class-${uid}" value="${escapeHtml(valOrEmpty(st.class))}"></td>
        <td><input id="mobile-${uid}" value="${escapeHtml(valOrEmpty(st.mobile))}"></td>
        <td><input id="whatsapp-${uid}" value="${escapeHtml(valOrEmpty(st.whatsapp))}"></td>
        <td><input id="address-${uid}" value="${escapeHtml(valOrEmpty(st.address))}"></td>
        <td class="actions">
          <button class="edit" onclick="editStudent('${uid}')">Save</button>
          <button class="delete" onclick="deleteStudent('${uid}')">Delete</button>
        </td>`;
      tbody.appendChild(row);
    });
    console.log('Displayed', filtered.length, 'students');
  } catch (err) {
    console.error('loadStudents error', err);
    tbody.innerHTML = '<tr><td colspan="8">Failed to load students. See console for error.</td></tr>';
    alert('Failed to load students — open console for details.');
  }
};

// update student
window.editStudent = async function(uid){
  try {
    const updates = {};
    updates[`users/${uid}/student/fullName`] = document.getElementById(`name-${uid}`).value.trim();
    updates[`users/${uid}/student/fatherName`] = document.getElementById(`father-${uid}`).value.trim();
    updates[`users/${uid}/student/motherName`] = document.getElementById(`mother-${uid}`).value.trim();
    updates[`users/${uid}/student/class`] = document.getElementById(`class-${uid}`).value.trim();
    updates[`users/${uid}/student/mobile`] = document.getElementById(`mobile-${uid}`).value.trim();
    updates[`users/${uid}/student/whatsapp`] = document.getElementById(`whatsapp-${uid}`).value.trim();
    updates[`users/${uid}/student/address`] = document.getElementById(`address-${uid}`).value.trim();

    console.log('Updating', updates);
    await update(ref(db), updates);
    alert('Student updated');
  } catch (e) {
    console.error('editStudent error', e);
    alert('Failed to update student — see console.');
  }
};

// delete student
window.deleteStudent = async function(uid){
  if(!confirm('Delete this student? This is permanent.')) return;
  try {
    await remove(ref(db, `users/${uid}`));
    alert('Deleted');
    // reload list (keep selected class)
    loadStudents();
  } catch (e) {
    console.error('deleteStudent error', e);
    alert('Failed to delete student — see console.');
  }
};

// simple escaper for attributes
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
</script>
</body>
</html>
